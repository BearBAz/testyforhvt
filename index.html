<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบจองห้องประชุม ศฝฟ.</title>
    
    <!-- Libraries -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        /* Theme Colors: Modern Teal & Slate */
        --primary: #0F766E; /* Deep Teal */
        --primary-light: #14B8A6; /* Vibrant Teal */
        --accent: #F0FDFA; /* Lightest Teal Background */
        --bg-body: #F3F4F6; /* Cool Grey */
        --surface: #FFFFFF;
        
        /* Text Colors */
        --text-main: #111827;
        --text-sub: #6B7280;
        --text-muted: #9CA3AF;
        
        /* Status Colors */
        --success: #10B981;
        --error: #EF4444;
        --warning: #F59E0B;
        
        /* UI Properties */
        --radius-xl: 24px;
        --radius-lg: 16px;
        --radius-md: 12px;
        --shadow-soft: 0 10px 40px -10px rgba(15, 118, 110, 0.1);
        --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --input-bg: #F9FAFB;
    }

    /* --- Reset & Global --- */
    * { box-sizing: border-box; outline: none; }
    
    body {
        font-family: 'Sarabun', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        overflow-x: hidden;
        min-height: 100vh;
        /* Abstract Background */
        background-image: 
            radial-gradient(at 0% 0%, rgba(20, 184, 166, 0.15) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(15, 118, 110, 0.1) 0px, transparent 50%);
        background-attachment: fixed;
    }

    /* --- Layout Architecture --- */
    .app-wrapper {
        display: flex;
        min-height: 100vh;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        gap: 2rem;
        align-items: flex-start;
    }

    /* Left Side: Brand & Info (Desktop) */
    .brand-section {
        flex: 1;
        position: sticky;
        top: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 2rem;
        display: none; /* Hidden on mobile by default */
    }

    .brand-section h1 {
        font-size: 3rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .brand-section p {
        font-size: 1.1rem;
        color: var(--text-sub);
        max-width: 400px;
        margin-bottom: 3rem;
    }

    .feature-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .f-icon {
        width: 48px;
        height: 48px;
        background: var(--surface);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        font-size: 1.25rem;
        box-shadow: var(--shadow-card);
    }

    /* Right Side: The Form */
    .form-container {
        flex: 1.2;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    /* --- Input Design System --- */
    .input-group-modern {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .input-modern {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem; /* Left padding for icon */
        background: var(--input-bg);
        border: 1px solid transparent;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-family: 'Sarabun', sans-serif;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--text-main);
    }

    .input-modern:focus {
        background: var(--surface);
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
    }

    .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        transition: color 0.3s ease;
        pointer-events: none;
    }

    .input-modern:focus + .input-icon,
    .input-modern:not(:placeholder-shown) + .input-icon {
        color: var(--primary);
    }
    
    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-main);
        display: block;
    }

    .required::after { content: "*"; color: var(--error); margin-left: 4px; }

    /* --- Custom Room Selector --- */
    .room-selector {
        position: relative;
    }

    .room-trigger {
        width: 100%;
        padding: 1rem;
        background: var(--surface);
        border: 2px solid #E5E7EB;
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }

    .room-trigger:hover { border-color: var(--text-muted); }
    .room-trigger.active { border-color: var(--primary); background: var(--accent); }

    .room-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0; right: 0;
        background: var(--surface);
        border-radius: var(--radius-md);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        z-index: 50;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #E5E7EB;
    }

    .room-dropdown.show {
        max-height: 350px;
        opacity: 1;
        overflow-y: auto;
    }

    .room-option {
        padding: 1rem;
        border-bottom: 1px solid #F3F4F6;
        cursor: pointer;
        transition: background 0.2s;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
    }
    
    .room-option:last-child { border-bottom: none; }
    .room-option:hover { background: var(--input-bg); }
    .room-option.disabled { opacity: 0.5; pointer-events: none; background: #F9FAFB; }

    .room-meta { font-size: 0.85rem; color: var(--text-sub); }
    .room-name { font-weight: 600; color: var(--text-main); font-size: 1rem; }
    
    .status-dot {
        height: 10px; width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    .status-available { background-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .status-unavailable { background-color: var(--error); }

    /* --- Accommodation Cards --- */
    .acc-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .acc-card {
        position: relative;
    }

    .acc-card input {
        position: absolute;
        opacity: 0;
        width: 0; height: 0;
    }

    .acc-content {
        background: var(--surface);
        border: 2px solid #E5E7EB;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .acc-card input:checked + .acc-content {
        border-color: var(--primary);
        background: var(--accent);
        box-shadow: 0 4px 12px rgba(15, 118, 110, 0.15);
        transform: translateY(-2px);
    }

    .acc-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        color: var(--text-muted);
        transition: color 0.3s;
    }

    .acc-card input:checked + .acc-content .acc-icon { color: var(--primary); }

    /* --- Accommodation Result Box (Dynamic) --- */
    /* Styling elements injected by JS */
    .accommodation-result-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        border: 1px solid #E5E7EB;
        overflow: hidden;
        margin-top: 1.5rem;
        box-shadow: var(--shadow-card);
        animation: slideDown 0.4s ease;
    }
    
    .acc-header {
        background: var(--accent);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(20, 184, 166, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .acc-title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px;}
    .acc-body { padding: 1.5rem; }
    
    .acc-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .acc-info-item {
        background: var(--input-bg);
        padding: 1rem;
        border-radius: var(--radius-md);
        text-align: center;
    }
    
    .room-status-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(16, 185, 129, 0.05);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .room-count-badge {
        background: var(--success);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .unavailable-message {
        background: #FEF2F2;
        border: 1px solid #FECACA;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
    }

    /* --- Buttons --- */
    .btn-submit {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        border: none;
        padding: 1.25rem;
        width: 100%;
        border-radius: var(--radius-xl);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(15, 118, 110, 0.3);
        transition: all 0.3s;
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(15, 118, 110, 0.4);
    }
    
    .btn-submit:disabled {
        background: var(--text-muted);
        transform: none;
        box-shadow: none;
    }

    /* --- Mobile Header --- */
    .mobile-nav {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 1rem;
        z-index: 100;
        border-bottom: 1px solid #E5E7EB;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }

    /* --- Responsive Breakpoints --- */
    @media (min-width: 992px) {
        .brand-section { display: flex; }
    }

    @media (max-width: 991px) {
        .app-wrapper {
            flex-direction: column;
            padding: 0;
            gap: 0;
        }
        
        .brand-section { display: none; }
        
        .mobile-nav { display: flex; }
        
        .form-container {
            border-radius: 30px 30px 0 0;
            margin-top: 60px; /* Space for nav */
            padding: 1.5rem;
            box-shadow: none;
            border: none;
            background: var(--surface);
        }
        
        .acc-grid { grid-template-columns: 1fr; }
        
        body { background: var(--bg-body); }
    }

    /* Animations */
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.9);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .loading-overlay.show { display: flex; }
    
    .spinner-bar {
        width: 120px;
        height: 4px;
        background: #E5E7EB;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    .spinner-progress {
        width: 50%;
        height: 100%;
        background: var(--primary);
        border-radius: 4px;
        animation: loadingBar 1.5s infinite ease-in-out;
    }
    @keyframes loadingBar { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

</style>
</head>
<body>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <i class="fas fa-bolt" style="color: var(--primary); font-size: 1.5rem;"></i>
        <span style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">ศฝฟ. Booking</span>
    </nav>

    <div class="app-wrapper">
        <!-- Left Column: Branding -->
        <div class="brand-section">
            <div style="width: 60px; height: 60px; background: white; border-radius: 16px; display:flex; align-items:center; justify-content:center; box-shadow: var(--shadow-card); margin-bottom: 2rem;">
                <i class="fas fa-bolt" style="font-size: 2rem; color: var(--primary);"></i>
            </div>
            <h1>Smart Space<br>Reservation</h1>
            <p>ระบบจองห้องประชุมและที่พักรูปแบบใหม่ รวดเร็ว ทันสมัย รองรับทุกการเชื่อมต่อ สำหรับบุคลากรศูนย์ฝึกปฏิบัติการไฟฟ้าแรงสูง</p>
            
            <div class="feature-list">
                <div class="feature-item">
                    <div class="f-icon"><i class="fas fa-calendar-check"></i></div>
                    <div>
                        <div style="font-weight:600;">Real-time Check</div>
                        <div style="font-size:0.9rem; color:var(--text-sub);">ตรวจสอบห้องว่างได้ทันที</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="f-icon"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <div style="font-weight:600;">Secure & Private</div>
                        <div style="font-size:0.9rem; color:var(--text-sub);">ข้อมูลปลอดภัยตามมาตรฐาน PDPA</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Form -->
        <div class="form-container">
            <h2 style="margin-bottom: 2rem; font-weight: 700; color: var(--text-main);">เริ่มการจอง</h2>
            
            <form id="bookingForm">
                <!-- Section 1: Identity -->
                <div style="margin-bottom: 2.5rem;">
                    <h5 style="color: var(--text-sub); margin-bottom: 1.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">ข้อมูลผู้ติดต่อ</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label required">ชื่อ-นามสกุล</label>
                            <div class="input-group-modern">
                                <input type="text" class="input-modern" id="fullName" name="fullName" placeholder=" " required>
                                <i class="fas fa-user input-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">สังกัด/หน่วยงาน</label>
                            <div class="input-group-modern">
                                <input type="text" class="input-modern" id="department" name="department" placeholder=" " required>
                                <i class="fas fa-building input-icon"></i>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label required">เบอร์โทรศัพท์</label>
                            <div class="input-group-modern">
                                <input type="tel" class="input-modern" id="phone" name="phone" placeholder=" " required>
                                <i class="fas fa-phone-alt input-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Booking Details -->
                <div style="margin-bottom: 2.5rem;">
                    <h5 style="color: var(--text-sub); margin-bottom: 1.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">รายละเอียดการจอง</h5>
                    
                    <label class="form-label required">หัวข้อการประชุม/หลักสูตร</label>
                    <div class="input-group-modern">
                        <input type="text" class="input-modern" id="courseName" name="courseName" placeholder=" " required>
                        <i class="fas fa-heading input-icon"></i>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">เริ่มวันที่</label>
                            <div class="input-group-modern" style="margin-bottom:0;">
                                <input type="date" class="input-modern" id="startDate" name="startDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">ถึงวันที่</label>
                            <div class="input-group-modern" style="margin-bottom:0;">
                                <input type="date" class="input-modern" id="endDate" name="endDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label required">ห้องประชุม</label>
                            <div class="room-selector">
                                <div class="room-trigger" id="customMeetingRoomSelect">
                                    <span style="color: var(--text-muted);">กรุณาเลือกวันที่ก่อน...</span>
                                    <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                                </div>
                                <div class="room-dropdown" id="meetingRoomOptions">
                                    <!-- Options injected via JS -->
                                </div>
                                <input type="hidden" id="meetingRoom" name="meetingRoom" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required">ผู้เข้าร่วม (คน)</label>
                            <div class="input-group-modern">
                                <input type="number" class="input-modern" id="attendees" name="attendees" min="1" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <i class="fas fa-users input-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Accommodation -->
                <div>
                    <h5 style="color: var(--text-sub); margin-bottom: 1.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">ที่พัก</h5>
                    
                    <div class="acc-grid">
                        <label class="acc-card">
                            <input type="radio" name="accommodation" value="ต้องการ" required>
                            <div class="acc-content">
                                <i class="fas fa-bed acc-icon"></i>
                                <span style="font-weight: 600;">ต้องการที่พัก</span>
                            </div>
                        </label>
                        <label class="acc-card">
                            <input type="radio" name="accommodation" value="ไม่ต้องการ">
                            <div class="acc-content">
                                <i class="fas fa-car acc-icon"></i>
                                <span style="font-weight: 600;">ไม่ต้องการ</span>
                            </div>
                        </label>
                    </div>

                    <!-- Dynamic Result Container -->
                    <div id="accommodationStatus" style="display: none;"></div>
                </div>

                <!-- Footer / Submit -->
                <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #E5E7EB;">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="pdpaConsent" required style="cursor:pointer; border-color: var(--text-muted);">
                        <label class="form-check-label" for="pdpaConsent" style="font-size: 0.9rem; color: var(--text-sub); cursor:pointer;">
                            ฉันยอมรับ <a href="#" onclick="showPDPADetail(event)" style="color: var(--primary); text-decoration: none; font-weight: 600;">เงื่อนไขการใช้บริการและนโยบายความเป็นส่วนตัว (PDPA)</a>
                        </label>
                    </div>

                    <button type="submit" class="btn-submit" id="submitBtn">
                        <span>ยืนยันการจอง</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <div class="text-center mt-3" style="font-size: 0.8rem; color: var(--text-muted);">
                        หากมีปัญหาการใช้งาน ติดต่อ 034-339-224
                    </div>
                </div>
            </form>
            
            <div id="messageContainer"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner-bar">
            <div class="spinner-progress"></div>
        </div>
        <div style="font-weight: 600; color: var(--text-main);">กำลังดำเนินการ...</div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ORIGINAL JAVASCRIPT LOGIC (Unchanged functionality) -->
<script>
    const LIFF_ID = "2007138631-Ono58j50";
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby8VAtdyxSMkPIIWNBAqUa9YJw2XNT7-fcPqbsSPqsk1IkrVex0X83DUMcGOmIdCJLPMw/exec";

    const bookingForm = document.getElementById('bookingForm');
    const submitBtn = document.getElementById('submitBtn');
    const messageContainer = document.getElementById('messageContainer');
    const loadingDiv = document.getElementById('loading');
    const accommodationStatusDiv = document.getElementById('accommodationStatus');
    const customMeetingRoomSelect = document.getElementById('customMeetingRoomSelect');
    const meetingRoomOptions = document.getElementById('meetingRoomOptions');
    const hiddenMeetingRoomInput = document.getElementById('meetingRoom');
    let userId = '';
    let displayName = '';
    let checkTimeout;
    let roomData = [];
    let accommodationAvailable = true;
    let maxAvailableRooms = 0;

    // --- Init LIFF ---
    async function initializeLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            userId = profile.userId;
            displayName = profile.displayName;
            await autofillUserData();
        } catch (err) {
            console.error('LIFF initialization error:', err);
        }
    }

    async function autofillUserData() {
        if (!userId) return;
        const autofillUrl = `${GAS_WEB_APP_URL}?userId=${userId}`;
        try {
            const response = await fetch(autofillUrl);
            const userData = await response.json();
            if (userData && userData.fullName) {
                document.getElementById('fullName').value = userData.fullName;
                document.getElementById('department').value = userData.department;
                document.getElementById('phone').value = userData.phone;
            }
        } catch (error) {
            console.error('Autofill error:', error);
        }
    }

    // --- Room Logic ---
    async function checkMeetingRoomAvailability() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const triggerLabel = customMeetingRoomSelect.querySelector('span');

        if (!startDate || !endDate) {
            triggerLabel.textContent = "กรุณาระบุวันที่ก่อน...";
            triggerLabel.style.color = "var(--text-muted)";
            meetingRoomOptions.innerHTML = '';
            return;
        }

        try {
            triggerLabel.textContent = "กำลังโหลดข้อมูล...";
            const checkUrl = `${GAS_WEB_APP_URL}?action=checkMeetingRoomAvailability&startDate=${startDate}&endDate=${endDate}`;
            const response = await fetch(checkUrl);
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            roomData = result.rooms || [];
            updateCustomMeetingRoomSelect(roomData);
            triggerLabel.textContent = "เลือกห้องประชุม";
            triggerLabel.style.color = "var(--text-main)";
        } catch (error) {
            console.error('Check room error:', error);
            triggerLabel.textContent = "ไม่สามารถโหลดข้อมูลได้";
            updateCustomMeetingRoomSelect([]);
        }
    }

    function updateCustomMeetingRoomSelect(rooms) {
        meetingRoomOptions.innerHTML = '';
        if (rooms.length === 0) {
            meetingRoomOptions.innerHTML = '<div class="room-option disabled" style="display:block; text-align:center;">ไม่มีข้อมูลห้องว่าง</div>';
            return;
        }

        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = `room-option ${!room.isAvailable ? 'disabled' : ''}`;
            // Styling structure for the new dropdown
            div.innerHTML = `
                <div>
                    <div class="room-name">${room.name}</div>
                    <div class="room-meta"><i class="fas fa-chair me-1"></i> ${room.category}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="status-dot ${room.isAvailable ? 'status-available' : 'status-unavailable'}"></span>
                    <span style="font-size:0.8rem; font-weight:600; color:${room.isAvailable ? 'var(--success)' : 'var(--error)'}">
                        ${room.isAvailable ? 'ว่าง' : 'ไม่ว่าง'}
                    </span>
                </div>
            `;

            if (room.isAvailable) {
                div.addEventListener('click', () => {
                    hiddenMeetingRoomInput.value = room.name;
                    customMeetingRoomSelect.querySelector('span').textContent = room.name;
                    customMeetingRoomSelect.querySelector('span').style.color = "var(--primary)";
                    customMeetingRoomSelect.classList.remove('active');
                    meetingRoomOptions.classList.remove('show');
                    hiddenMeetingRoomInput.dispatchEvent(new Event('change'));
                });
            }
            meetingRoomOptions.appendChild(div);
        });
    }

    // --- Accommodation Logic ---
    async function checkAccommodation() {
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(async () => {
            const accommodationChoice = document.querySelector('input[name="accommodation"]:checked');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const attendeesInput = document.getElementById('attendees').value;
            const attendees = parseInt(attendeesInput) || 0;
            const container = document.getElementById('accommodationStatus');

            maxAvailableRooms = 0;
            accommodationAvailable = true;

            if (!accommodationChoice || accommodationChoice.value !== 'ต้องการ') {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            if (!startDate || !endDate || attendees <= 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = `
                <div class="accommodation-result-card" style="padding: 2rem; text-align: center;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div style="margin-top: 10px; color: var(--text-sub);">กำลังตรวจสอบห้องพัก...</div>
                </div>`;

            try {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const checkin = new Date(startDateObj); checkin.setDate(startDateObj.getDate() - 1);
                const apiCheckout = new Date(endDateObj); apiCheckout.setDate(endDateObj.getDate() - 1);
                const checkinStr = checkin.toISOString().split('T')[0];
                const apiCheckoutStr = apiCheckout.toISOString().split('T')[0];
                const dateOptions = { day: 'numeric', month: 'short', year: '2-digit' };
                const showCheckin = checkin.toLocaleDateString('th-TH', dateOptions);
                const showCheckout = endDateObj.toLocaleDateString('th-TH', dateOptions);
                const diffTime = Math.abs(endDateObj - checkin);
                const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const checkUrl = `${GAS_WEB_APP_URL}?action=checkAvailability&checkin=${checkinStr}&checkout=${apiCheckoutStr}`;
                const response = await fetch(checkUrl);
                const result = await response.json();

                if (result.error) throw new Error(result.error);
                maxAvailableRooms = result.availableRooms;
                const suggestedRooms = Math.ceil(attendees / 2);

                if (maxAvailableRooms > 0 && maxAvailableRooms >= suggestedRooms) {
                    accommodationAvailable = true;
                    const defaultInputValue = suggestedRooms;
                    const quotaLimit = suggestedRooms + 5;

                    // Updated HTML Structure for Accommodation Result
                    container.innerHTML = `
                    <div class="accommodation-result-card">
                        <div class="acc-header">
                            <div class="acc-title"><i class="fas fa-check-circle me-2"></i> จองที่พัก (${nights} คืน)</div>
                            <span class="room-count-badge">ว่าง ${maxAvailableRooms} ห้อง</span>
                        </div>
                        <div class="acc-body">
                            <div class="acc-info-grid">
                                <div class="acc-info-item">
                                    <small style="color:var(--text-sub);">Check-in (14:00)</small>
                                    <div style="font-weight:600;">${showCheckin}</div>
                                </div>
                                <div class="acc-info-item">
                                    <small style="color:var(--text-sub);">Check-out (10:00)</small>
                                    <div style="font-weight:600;">${showCheckout}</div>
                                </div>
                            </div>

                            <label class="form-label required">ระบุจำนวนห้อง</label>
                            <div style="display:flex; gap:1rem; align-items:center;">
                                <div class="input-group-modern" style="margin-bottom:0; width: 120px;">
                                    <input type="number" class="input-modern" id="numRooms" name="numRooms" min="1" max="${maxAvailableRooms}" value="${defaultInputValue}" required style="text-align:center; padding-left:1rem;">
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-sub);">
                                    <span style="color:var(--success); font-weight:600;"><i class="fas fa-lightbulb"></i> แนะนำ ${suggestedRooms} ห้อง</span><br>
                                    (สำหรับ ${attendees} ท่าน)
                                </div>
                            </div>
                            <div id="roomAlert" style="color:var(--error); font-size:0.85rem; margin-top:0.5rem; display:none;"></div>
                        </div>
                    </div>`;

                    const numRoomsInput = document.getElementById('numRooms');
                    const roomAlert = document.getElementById('roomAlert');
                    
                    numRoomsInput.addEventListener('input', function() {
                        const val = parseInt(this.value);
                        if (isNaN(val) || val <= 0) {
                            this.style.borderColor = "var(--error)";
                            roomAlert.style.display = 'block';
                            roomAlert.textContent = "ระบุอย่างน้อย 1 ห้อง";
                        } else if (val > maxAvailableRooms) {
                            this.style.borderColor = "var(--error)";
                            roomAlert.style.display = 'block';
                            roomAlert.textContent = `ห้องว่างเหลือเพียง ${maxAvailableRooms} ห้อง`;
                        } else if (val > quotaLimit) {
                            this.style.borderColor = "var(--error)";
                            roomAlert.style.display = 'block';
                            roomAlert.textContent = "เกินโควต้า (สูงสุด +5 จากคำแนะนำ)";
                        } else {
                            this.style.borderColor = "transparent";
                            roomAlert.style.display = 'none';
                        }
                    });

                } else {
                    accommodationAvailable = false;
                    container.innerHTML = `
                    <div class="unavailable-message" style="margin-top: 1.5rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error); margin-bottom: 1rem;"></i>
                        <h6 style="color: var(--error); font-weight: 700;">ที่พักไม่เพียงพอ</h6>
                        <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 0;">
                            ต้องการ ${suggestedRooms} ห้อง แต่มีห้องว่างเพียง ${maxAvailableRooms} ห้อง<br>
                            กรุณาปรับเปลี่ยนวันที่ หรือติดต่อเจ้าหน้าที่
                        </p>
                    </div>`;
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="alert alert-danger mt-3">ระบบขัดข้อง ตรวจสอบห้องพักไม่ได้</div>`;
            }
        }, 600);
    }

    // --- Events ---
    // Toggle Room Dropdown
    customMeetingRoomSelect.addEventListener('click', (e) => {
        e.stopPropagation();
        customMeetingRoomSelect.classList.toggle('active');
        meetingRoomOptions.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!customMeetingRoomSelect.contains(e.target)) {
            customMeetingRoomSelect.classList.remove('active');
            meetingRoomOptions.classList.remove('show');
        }
    });

    document.getElementById('startDate').addEventListener('change', () => {
        checkMeetingRoomAvailability();
        checkAccommodation();
    });
    document.getElementById('endDate').addEventListener('change', () => {
        checkMeetingRoomAvailability();
        checkAccommodation();
    });
    document.getElementById('attendees').addEventListener('input', checkAccommodation);
    document.querySelectorAll('input[name="accommodation"]').forEach(radio => 
        radio.addEventListener('change', checkAccommodation)
    );

    // Form Submit
    bookingForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const pdpaCheckbox = document.getElementById('pdpaConsent');
        if (!pdpaCheckbox.checked) {
            Swal.fire({ icon: 'warning', title: 'แจ้งเตือน', text: 'กรุณายอมรับเงื่อนไข PDPA', confirmButtonColor: '#0F766E'});
            return;
        }

        const accommodationChoice = document.querySelector('input[name="accommodation"]:checked');
        let numRoomsValue = 0;

        if (accommodationChoice && accommodationChoice.value === 'ต้องการ') {
            const numRoomsInput = document.getElementById('numRooms');
            if (numRoomsInput) {
                numRoomsValue = parseInt(numRoomsInput.value) || 0;
                // Validation Logic
                const currentAttendees = parseInt(document.getElementById('attendees').value) || 0;
                const suggested = Math.ceil(currentAttendees / 2);
                const quotaLimit = suggested + 5;

                if (numRoomsValue > maxAvailableRooms || numRoomsValue > quotaLimit || numRoomsValue <= 0) {
                    Swal.fire({ icon: 'error', title: 'ข้อมูลห้องพักไม่ถูกต้อง', confirmButtonColor: '#0F766E'});
                    return;
                }
            } else if (!accommodationAvailable) {
                Swal.fire({ icon: 'error', title: 'ที่พักไม่เพียงพอ', text: 'กรุณาเปลี่ยนวัน หรือเลือกไม่ต้องการที่พัก', confirmButtonColor: '#0F766E'});
                return;
            }
        }

        const selectedRoomName = hiddenMeetingRoomInput.value;
        const attendees = parseInt(document.getElementById('attendees').value) || 0;
        const roomConfig = roomData.find(r => r.name === selectedRoomName);

        if (roomConfig && !roomConfig.isAvailable) {
            Swal.fire({ icon: 'error', title: 'ห้องประชุมไม่ว่าง', confirmButtonColor: '#0F766E'});
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...';
        loadingDiv.classList.add('show');

        const formData = new FormData(event.target);
        const data = {
            userId: userId,
            displayName: displayName,
            fullName: formData.get('fullName'),
            department: formData.get('department'),
            phone: formData.get('phone'),
            courseName: formData.get('courseName'),
            startDate: formData.get('startDate'),
            endDate: formData.get('endDate'),
            meetingRoom: formData.get('meetingRoom'),
            accommodation: formData.get('accommodation'),
            attendees: formData.get('attendees'),
            numRooms: numRoomsValue,
            timestamp: new Date().toISOString()
        };

        try {
            await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            loadingDiv.classList.remove('show');
            await Swal.fire({
                title: 'จองสำเร็จ!',
                text: 'ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว',
                icon: 'success',
                confirmButtonText: 'ตกลง',
                confirmButtonColor: '#0F766E'
            }).then(() => {
                if (liff.isInClient()) liff.closeWindow();
                else window.location.reload();
            });

        } catch (error) {
            console.error(error);
            loadingDiv.classList.remove('show');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ยืนยันการจอง';
            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถส่งข้อมูลได้', confirmButtonColor: '#EF4444'});
        }
    });

    // PDPA & Min Date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').setAttribute('min', today);
    document.getElementById('startDate').addEventListener('change', function() {
        document.getElementById('endDate').setAttribute('min', this.value);
    });

    function showPDPADetail(e) {
        e.preventDefault();
        Swal.fire({
            title: 'นโยบายความเป็นส่วนตัว',
            html: '<div style="text-align:left; font-size:0.9rem;">ข้อมูลของท่านจะถูกเก็บรักษาเป็นความลับ... (ข้อความ PDPA)</div>',
            confirmButtonText: 'รับทราบ',
            confirmButtonColor: '#0F766E'
        });
    }

    document.addEventListener('DOMContentLoaded', initializeLiff);

</script>
</body>
</html>
